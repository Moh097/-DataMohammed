---
title: "Data"
author: "masri"
date: "2023-08-06"
output: html_document
---

A code chunk only for libraries.
```{r}

```


taking only the 7 desired countries from the original dataset. 7 Wave
```{r}
desired_countries <- c("JOR", "IRQ", "TUN", "MOR", "EGY", "LBN", "LIB")

# Filter the data for specific countries
Wave_7 <- Wave_7[Wave_7$C_COW_ALPHA %in% desired_countries, ]

```

taking only the 7 desired countries from the original dataset. 6 Wave
```{r}
desired_countries <- c("JOR", "IRQ", "TUN", "MOR", "EGY", "LEB", "LBY")

# Filter the data for specific countries
Wave_6 <- Wave_6[Wave_6$C_COW_ALPHA %in% desired_countries, ]

```
# List of specific countries

Take only specific columns after we extracted only the desired countries. 7 Wave
```{r}

Wave_7_selected <- subset(Wave_7, select = c("C_COW_ALPHA", "Q46",
                                                                "Q47", "Q48", "Q49",
                                             "Q50", "Q57","Q65", "Q68", "Q70", "Q71", "Q72",
                                             "Q73","Q209", "Q210", "Q211", "Q212", "Q213",
                                             "Q215", "Q218", "Q219", "Q220", "Q173",
                                             "Q262", "Q260", "Q279"))

```

Take only specific columns after we extracted only the desired countries. 6 Wave

```{r cars}

Wave_6_selected <- subset(Wave_6, select = c("C_COW_ALPHA", "V10", "V11", "V55", "V23",
                                             "V59", "V24","V109", "V112", "V114", "V115",
                                             "V116","V117", "V85", "V86", "V87", "V88",
                                             "V147","V242", "V240", "V229"))

```


naming the attributes with meaningful names. 7 Wave

```{r}
library(dplyr)
Wave_7_renamed <- Wave_7_selected %>%
   rename(happiness = Q46, free_choice = Q48, health = Q47, life_satis = Q49,
          financial_satis = Q50, gen_trust = Q57,
          armed_trust = Q65, labor_trust = Q68, court_trust = Q70, gov_trust = Q71, 
          parties_trust = Q72, Parliament_trust = Q73, sign_pet = Q209, join_boycott = Q210,
          attend_demo = Q211, join_strike = Q212, donate = Q213, enc_poli = Q215, 
          sign_pet_onli = Q218, enc_poli_onli = Q219, org_poli_onli = Q220,
          religiosity = Q173, age = Q262, gender = Q260, employment = Q279, 
          country = C_COW_ALPHA)
          
```

naming the attributes with meaningful names. 6 Wave

```{r}
library(dplyr)
Wave_6_renamed <- Wave_6_selected %>%
   rename(happiness = V10, health = V11, free_choice = V55, life_satis = V23, 
          financial_satis = V59, gen_trust = V24, armed_trust = V109, 
          labor_trust = V112, court_trust = V114, gov_trust = V115, parties_trust = V116,
          Parliament_trust = V117, sign_pet = V85, join_boycott = V86, attend_demo = V87,
          join_strike = V88, religiosity = V147, age = V242, gender = V240,
          employment = V229, country = C_COW_ALPHA)
          
```

cleaning the dataset. 7 Wave
```{r}
for (col in names(Wave_7_renamed)) {
  Wave_7_renamed[[col]][Wave_7_renamed[[col]] %in% 
  c(-1, -2, -4, -5)] <- NA
}

```

cleaning the dataset. 6 Wave
```{r}
for (col in names(Wave_6_renamed)) {
  Wave_6_renamed[[col]][Wave_6_renamed[[col]] %in% 
  c(-1, -2, -4, -5)] <- NA
}
```

merge the two data sets.
```{r}
library(dplyr)
merged_data <- bind_rows(Wave_6_renamed, Wave_7_renamed)
merged_data <- merged_data[, !(names(merged_data) %in% c("org_poli_onli", "enc_poli_onli"
                                                         , "sign_pet_onli", "donate",
                                                         "enc_poli"))]
```


```{r}
library(ggplot2)

# Assuming 'merged_data' is your data frame
missing_proportions <- colMeans(is.na(merged_data))
missing_data_df <- data.frame(variable = names(missing_proportions), proportion = missing_proportions)

# Create a bar chart to visualize missing data proportions
ggplot(missing_data_df, aes(x = variable, y = proportion)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  labs(title = "Proportion of Missing Data by Variable", x = "Variable", y = "Proportion Missing") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


``` {r}
library(naniar)
library(ggplot2)

# Function to summarize and visualize missing data for each country
missing_summary_and_visualization_by_country <- function(merged_data) {
  country <- unique(merged_data$country)[1]
  missing_summary <- sapply(merged_data, function(x) sum(is.na(x)))
  print(paste("Missing data summary for", country, ":"))
  print(missing_summary)
  
  plot <- naniar::vis_miss(merged_data) + 
    ggtitle(paste("Missing Data Visualization for", country)) +
    theme_minimal() +
    theme(plot.margin = margin(t = 0.5, r = 0.5, b = 2, l = 0.5, unit = "cm"),
          axis.text.x = element_text(angle = 90, hjust = 1))  # Adjust angle and bottom margin
  
  print(plot)
}

# Apply the function to each subset of the data, grouped by country
by(merged_data, merged_data$country, missing_summary_and_visualization_by_country)

```

```{r}
library(dplyr)
library(tidyr)
merged_data %>%
  group_by(country) %>%
  summarise(across(
    .cols = everything(),
    .fns = ~ mean(is.na(.x)),
    .names = "{.col}_missing_proportion"
  )) -> missing_proportions

# Print the result
print(missing_proportions)
```

```{r}
library(dlookr)
plot_na_pareto(merged_data)
plot_na_intersect(merged_data)
```

```{r}
library(naniar)
gg_miss_fct(x = merged_data, fct = country)
```

```{r}
library(ggplot2)
merged_data_na <- data.frame(merged_data)
imputed_data <- imputate_na(merged_data_na, armed_trust, method = "mean")
plot(merged_data_na)
```

```{r}
library(missRanger)
merged_imputet <- missRanger(
  merged_data_na, 
  formula = . ~ . ,
  num.trees = 1000, 
  verbose = 2, 
  seed = 111,  
  returnOOB = T)
```

```{r}
library(ggplot2)
library(dplyr)
column_to_exclude <- "country"
merged_imputet_rounded <- merged_imputet %>%
  mutate(across(-all_of(column_to_exclude), round, 0))
ggplot()+
  geom_point(data = merged_imputet_rounded, aes(country, armed_trust), 
             color = "red")+
  geom_point(data = merged_data_na, aes(country, armed_trust))+
  theme_minimal()
```

```{r}
library(dplyr)
library(tidyr)
merged_imputet_rounded %>%
  group_by(country) %>%
  summarise(across(
    .cols = everything(),
    .fns = ~ mean(is.na(.x)),
    .names = "{.col}_missing_proportion"
  )) -> missing_proportions

# Print the result
print(missing_proportions)
```