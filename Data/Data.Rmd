---
title: "Data"
author: "masri"
date: "2023-08-06"
output: html_document
---

A code chunk only for libraries.
```{r}
unique_dataset <- final_dataset %>% 
  select(country, var) %>% 
  distinct()

# Print the unique dataset
print(unique_dataset)
names(final_dataset)
```

```{r}
# Load the required library
library(dplyr)

# Your existing dataset is assumed to be 'merged_data' and your newly created dataset is 'filtered_data'

# Create a mapping dataframe for country abbreviations and full names
country_mapping <- data.frame(
  country = c("JOR", "IRQ", "TUN", "MOR", "EGY", "LEB", "LIB"),
  countryname = c("Jordan", "Iraq", "Tunisia", "Morocco", "Egypt, Arab Rep.", "Lebanon", "Libya")
)

# Merge the mapping dataframe with the existing dataset to get full country names
merged_data_with_fullnames <- left_join(merged_data, country_mapping, by = "country")

# Merge to add the 'var' column from filtered_data
final_dataset <- left_join(merged_data_with_fullnames, filtered_data[, c("countryname", "var")], by = "countryname")

# Optionally, remove the 'countryname' column after the merging
final_dataset$countryname <- NULL

```


```{r}
# Load dplyr package
library(dplyr)

# Original dataset is wgidataset

# Create a data frame containing the target countries and years
target_data <- data.frame(
  countryname = c("Egypt, Arab Rep.", "Iraq", "Jordan", "Lebanon", "Libya", "Morocco", "Tunisia"),
  year = c(2016, 2016, 2016, 2016, 2017, 2016, 2016)
)

# Merge the original dataset (wgidataset) with target_data on 'countryname' and 'year'
filtered_data <- wgidataset %>%
  inner_join(target_data, by = c("countryname", "year")) %>%
  select(countryname, year, var)  # select only the columns we need

# View the filtered data
print(filtered_data)


```

# List of specific countries

Take only specific columns after we extracted only the desired countries. 7 Wave
```{r}

# List of desired countries
desired_countries <- c("JOR", "IRQ", "TUN", "MOR", "EGY", "LEB", "LIB")

# Filter the dataset to include only the desired countries
Wave_7_selected <- subset(Wave_7, C_COW_ALPHA %in% desired_countries, select = c("C_COW_ALPHA", "Q46",
                                                                "Q47", "Q48", "Q49",
                                             "Q50", "Q57", "Q209", "Q210", "Q211", "Q212",
                                             "Q213",
                                             "Q215", "Q218", "Q219", "Q220", "Q173",
                                             "Q262", "Q260", "Q279"))

```

Take only specific columns after we extracted only the desired countries. 6 Wave
```{r}
# List of desired countries
desired_countries <- c("JOR", "IRQ", "TUN", "MOR", "EGY", "LEB", "LBY")

# Filter the dataset to include only the desired countries
Wave_6_selected <- subset(Wave_6, C_COW_ALPHA %in% desired_countries, select = c("C_COW_ALPHA", "V10", "V11", "V55", "V23",
                                             "V59", "V24", "V85", "V86", "V87", "V88",
                                             "V147","V242", "V240", "V229"))

```

naming the attributes with meaningful names. 7 Wave
```{r}
library(dplyr)
Wave_7_renamed <- Wave_7_selected %>%
   rename(happiness = Q46, free_choice = Q48, health = Q47, life_satis = Q49,
          financial_satis = Q50, gen_trust = Q57,
          sign_pet = Q209, join_boycott = Q210,
          attend_demo = Q211, join_strike = Q212, donate = Q213, enc_poli = Q215, 
          sign_pet_onli = Q218, enc_poli_onli = Q219, org_poli_onli = Q220,
          religiosity = Q173, age = Q262, gender = Q260, employment = Q279 , 
          country = C_COW_ALPHA)
          
```

naming the attributes with meaningful names. 6 Wave
```{r}
library(dplyr)
Wave_6_renamed <- Wave_6_selected %>%
   rename(happiness = V10, health = V11, free_choice = V55, life_satis = V23, 
          financial_satis = V59, gen_trust = V24, sign_pet = V85, join_boycott = V86,
          attend_demo = V87,
          join_strike = V88, religiosity = V147, age = V242, gender = V240,
          employment = V229, country = C_COW_ALPHA)
          
```

cleaning the dataset. 7 Wave
```{r}
for (col in names(Wave_7_renamed)) {
  Wave_7_renamed[[col]][Wave_7_renamed[[col]] %in% 
  c(-1, -2, -4, -5)] <- NA
}

```

cleaning the dataset. 6 Wave
```{r}
for (col in names(Wave_6_renamed)) {
  Wave_6_renamed[[col]][Wave_6_renamed[[col]] %in% 
  c(-1, -2, -4, -5)] <- NA
}
```

merge the two data sets.
```{r}
# Load required libraries
library(dplyr)

# Create a mapping to align country codes
country_mapping <- data.frame(original_country = c('LIB'), mapped_country = c('LBY'))

# Apply the mapping to Wave_6_renamed dataset
Wave_6_renamed <- Wave_6_renamed %>%
  left_join(country_mapping, by = c("country" = "original_country")) %>%
  mutate(country = coalesce(mapped_country, country)) %>%
  select(-mapped_country)

# Merge the datasets (Wave_6_renamed and Wave_7_renamed)
merged_data <- bind_rows(Wave_6_renamed, Wave_7_renamed)

# Remove unwanted columns
merged_data <- merged_data[, !(names(merged_data) %in% c("org_poli_onli", "enc_poli_onli", "sign_pet_onli", "donate", "enc_poli"))]
unique(merged_data$country)

```

visualize the missing values for every attibute in the merged data.
```{r}
library(ggplot2)

# Assuming 'merged_data' is your data frame
missing_proportions <- colMeans(is.na(merged_data))
missing_data_df <- data.frame(variable = names(missing_proportions), proportion = missing_proportions)

# Create a bar chart to visualize missing data proportions
ggplot(missing_data_df, aes(x = variable, y = proportion)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  labs(title = "Proportion of Missing Data by Variable", x = "Variable", y = "Proportion Missing") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

specifying the location of the missing values within the attributes in the merged data.
``` {r}
library(naniar)
library(ggplot2)

# Function to summarize and visualize missing data for each country
missing_summary_and_visualization_by_country <- function(merged_data) {
  country <- unique(merged_data$country)[1]
  missing_summary <- sapply(merged_data, function(x) sum(is.na(x)))
  print(paste("Missing data summary for", country, ":"))
  print(missing_summary)
  
  plot <- naniar::vis_miss(merged_data) + 
    ggtitle(paste("Missing Data Visualization for", country)) +
    theme_minimal() +
    theme(plot.margin = margin(t = 0.5, r = 0.5, b = 2, l = 0.5, unit = "cm"),
          axis.text.x = element_text(angle = 90, hjust = 1))  # Adjust angle and bottom margin
  
  print(plot)
}

# Apply the function to each subset of the data, grouped by country
by(merged_data, merged_data$country, missing_summary_and_visualization_by_country)

```

calculating and printing the propotions of the missing data in the merged data.
```{r}
library(dplyr)
library(writexl)

# Your existing code for summarizing missing proportions
merged_data %>%
  group_by(country) %>%
  summarise(across(
    .cols = everything(),
    .fns = ~ mean(is.na(.x)),
    .names = "{.col}_missing_proportion"
  )) -> missing_proportions

# Specify the file path where you want to save the Excel file
output_path <- "C:/Users/LENOVO/Desktop/DataMohammed/Data/missing_proportion.xlsx"

# Save the summarized data to an Excel file
write_xlsx(missing_proportions, path = output_path)

cat("Excel file saved at:", output_path, "\n")
```

visualize the missing data according to the attributes in merged data using dlookr library.
```{r}
library(dlookr)
plot_na_pareto(merged_data)
plot_na_intersect(merged_data)
```

a heat map for the miising data in the merged data.
```{r}
library(naniar)
gg_miss_fct(x = merged_data, fct = country)
```

creating a data frame to do iterations and imputation then do the missForest imputation method to handle the missing data.
```{r}
library(missRanger)
library(ggplot2)

merged_data_na <- data.frame(final_dataset)

merged_imputet <- missRanger(
  merged_data_na, 
  formula = . ~ . ,
  num.trees = 1000, 
  verbose = 2, 
  seed = 111,  
  returnOOB = T)
```

calculating and printing the propotions of the missing data in the merged data after the imputation.
```{r}
library(dplyr)
library(tidyr)
merged_imputet_rounded %>%
  group_by(country) %>%
  summarise(across(
    .cols = everything(),
    .fns = ~ mean(is.na(.x)),
    .names = "{.col}_missing_proportion"
  )) -> missing_proportions_imputed

# Print the result
print(missing_proportions_imputed)
```

comparison between the imputed and the original data for *all attributes* by bar chart. *imputed in red*.
```{r}
library(ggplot2)
library(scales)

# Create the plot
data_columns <- setdiff(names(merged_data), c("country", "age", "gender"))

# Create a list to store plots
plots <- list()

# Generate bar charts for each column
for (col in data_columns) {
  unique_values <- unique(merged_data[[col]])
  plot <- ggplot() +
    geom_bar(data = merged_data, aes(x = factor(.data[[col]])), width = 0.3) +
    geom_bar(data = merged_imputet_rounded, aes(x = factor(.data[[col]])), fill = "red",
             position = position_nudge(x = 0.25), width = 0.3) +
    scale_x_discrete(breaks = unique_values, labels = numeric_labels[match(unique_values, merged_data[[col]])]) +
    labs(title = paste("Bar Chart for", col)) +
    theme_minimal()
  
  plots[[col]] <- plot
}

# Specify the file path where you want to save the PDF file
output_path <- "C:/Users/LENOVO/Desktop/DataMohammed/Data/plots.pdf"

# Create a PDF device
pdf(output_path)

# Print or display the generated plots and save them in the PDF
for (col in data_columns) {
  print(plots[[col]])
}

# Close the PDF device
dev.off()

cat("PDF file saved at:", output_path, "\n")

```


comparison between the imputed and the original data for *religiosity* by bar chart. *imputed in red*.
```{r}
library(ggplot2)
library(scales)

# Define the string labels and their corresponding numeric values
numeric_labels <- c("1" = "Several times a day", "2"  = "Once a day",
                    "3" = "Several times each week",
                    "4" = "Only when attending religious services",
                    "5" = "Only on special holy days", "6" = "Once a year",
                    "7" = "Less often", "8" = "Never, practically never",
                    "null" = "null")

# Create the plot
ggplot() +
  geom_bar(data = merged_data, aes(x = factor(religiosity)), width = 0.3) +
  geom_bar(data = merged_imputet_rounded, aes(x = factor(religiosity)), fill = "red",
           position = position_nudge(x = 0.25), width = 0.3) +
  scale_x_discrete(breaks = unique(merged_data$religiosity), 
                   labels = numeric_labels) +  # Apply labels
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate and adjust

```

comparison between the imputed and the original data for *happiness* by bar chart. *imputed in red*.
```{r}
library(ggplot2)
library(scales)

# Define the string labels and their corresponding numeric values
numeric_labels <- c("1" = "Very happy", "2"  = "Quite happy", "3" = "Not very happy",
                    "4" = "Not at all happy", "null" = "null")

# Create the plot
ggplot() +
  geom_bar(data = merged_data, aes(x = factor(happiness)), width = 0.3) +
  geom_bar(data = merged_imputet_rounded, aes(x = factor(happiness)), fill = "red",
           position = position_nudge(x = 0.25), width = 0.3) +
  scale_x_discrete(breaks = unique(merged_data$happiness), 
                   labels = numeric_labels) +  # Apply labels
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate and adjust

```

comparison between the imputed and the original data for *free_choice* by bar chart. *imputed in red*.
```{r}
library(ggplot2)
library(scales)

# Define the string labels and their corresponding numeric values
numeric_labels <- c("1" = "None at all", "2" = "2", "3" = "3", "4" = "4", "5" = "5",
                    "6" = "6", "7" = "7", "8" = "8", "9" = "9",
                    "10" = "A great deal", "null" = "null ")

# Create the plot
ggplot() +
  geom_bar(data = merged_data, aes(x = factor(free_choice)), width = 0.3) +
  geom_bar(data = merged_imputet_rounded, aes(x = factor(free_choice)), fill = "red",
           position = position_nudge(x = 0.25), width = 0.3) +
  scale_x_discrete(breaks = unique(merged_data$free_choice), 
                   labels = numeric_labels) +  # Apply labels
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate and adjust

```

comparison between the imputed and the original data for *health* by bar chart. *imputed in red*.
```{r}
library(ggplot2)
library(scales)

# Define the string labels and their corresponding numeric values
numeric_labels <- c("1" = "Very good", "2" = "Good", "3" = "Fair",
                    "4" = "Poor", "null" = "null ")

# Create the plot
data_columns <- setdiff(names(merged_data), c("country", "age", "gender"))
ggplot() +
  geom_bar(data = merged_data, aes(x = factor(health)), width = 0.3) +
  geom_bar(data = merged_imputet_rounded, aes(x = factor(health)), fill = "red",
           position = position_nudge(x = 0.25), width = 0.3) +
  scale_x_discrete(breaks = unique(merged_data$health), 
                   labels = numeric_labels) +  # Apply labels
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate and adjust

```

comparison between the imputed and the original data for *life_satis* by bar chart. *imputed in red*.
```{r}
library(ggplot2)
library(scales)

# Define the string labels and their corresponding numeric values
numeric_labels <- c("1" = "Completely dissatisfied", "2" = "2", "3" = "3",
                    "4" = "4", "5" = "5", "6" = "6", "7" = "7", "8" = "8",
                    "9" = "9","10" = "Completely satisfied", "null" = "null")

# Create the plot
data_columns <- setdiff(names(merged_data), c("country", "age", "gender"))
ggplot() +
  geom_bar(data = merged_data, aes(x = factor(life_satis)), width = 0.3) +
  geom_bar(data = merged_imputet_rounded, aes(x = factor(life_satis)), fill = "red",
           position = position_nudge(x = 0.25), width = 0.3) +
  scale_x_discrete(breaks = unique(merged_data$life_satis), 
                   labels = numeric_labels) +  # Apply labels
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate and adjust

```

comparison between the imputed and the original data for *financial_satis* by bar chart. *imputed in red*.
```{r}
library(ggplot2)
library(scales)

# Define the string labels and their corresponding numeric values
numeric_labels <- c("1" = "dissatisfied", "2" = "2", "3" = "3",
                    "4" = "4", "5" = "5", "6" = "6", "7" = "7", "8" = "8",
                    "9" = "9","10" = "satisfied", "null" = "null")

# Create the plot
data_columns <- setdiff(names(merged_data), c("country", "age", "gender"))
ggplot() +
  geom_bar(data = merged_data, aes(x = factor(financial_satis)), width = 0.3) +
  geom_bar(data = merged_imputet_rounded, aes(x = factor(financial_satis)), fill = "red",
           position = position_nudge(x = 0.25), width = 0.3) +
  scale_x_discrete(breaks = unique(merged_data$financial_satis), 
                   labels = numeric_labels) +  # Apply labels
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate and adjust

```

comparison between the imputed and the original data for *gen_trust* by bar chart. *imputed in red*.
```{r}
library(ggplot2)
library(scales)

# Define the string labels and their corresponding numeric values
numeric_labels <- c("1" = "Most people can be trusted", "2" = "Need to be very careful",
                    "null" = "null ")

# Create the plot
data_columns <- setdiff(names(merged_data), c("country", "age", "gender"))
ggplot() +
  geom_bar(data = merged_data, aes(x = factor(gen_trust)), width = 0.3) +
  geom_bar(data = merged_imputet_rounded, aes(x = factor(gen_trust)), fill = "red",
           position = position_nudge(x = 0.25), width = 0.3) +
  scale_x_discrete(breaks = unique(merged_data$gen_trust), 
                   labels = numeric_labels) +  # Apply labels
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate and adjust

```

comparison between the imputed and the original data for *sign_pet* by bar chart. *imputed in red*.
```{r}
library(ggplot2)
library(scales)

# Define the string labels and their corresponding numeric values
numeric_labels <- c("1" = "Have done", "2" = "Might do",
                    "3" = "Would never do", "null" = "null ")

# Create the plot
data_columns <- setdiff(names(merged_data), c("country", "age", "gender"))
ggplot() +
  geom_bar(data = merged_data, aes(x = factor(sign_pet)), width = 0.3) +
  geom_bar(data = merged_imputet_rounded, aes(x = factor(sign_pet)), fill = "red",
           position = position_nudge(x = 0.25), width = 0.3) +
  scale_x_discrete(breaks = unique(merged_data$sign_pet), 
                   labels = numeric_labels) +  # Apply labels
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate and adjust

```

comparison between the imputed and the original data for *join_boycott* by bar chart. *imputed in red*.
```{r}
library(ggplot2)
library(scales)

# Define the string labels and their corresponding numeric values
numeric_labels <- c("1" = "Have done", "2" = "Might do",
                    "3" = "Would never do", "null" = "null ")

# Create the plot
data_columns <- setdiff(names(merged_data), c("country", "age", "gender"))
ggplot() +
  geom_bar(data = merged_data, aes(x = factor(join_boycott)), width = 0.3) +
  geom_bar(data = merged_imputet_rounded, aes(x = factor(join_boycott)), fill = "red",
           position = position_nudge(x = 0.25), width = 0.3) +
  scale_x_discrete(breaks = unique(merged_data$join_boycott), 
                   labels = numeric_labels) +  # Apply labels
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate and adjust

```

comparison between the imputed and the original data for *attend_demo* by bar chart. *imputed in red*.
```{r}
library(ggplot2)
library(scales)

# Define the string labels and their corresponding numeric values
numeric_labels <- c("1" = "Have done", "2" = "Might do",
                    "3" = "Would never do", "null" = "null ")

# Create the plot
data_columns <- setdiff(names(merged_data), c("country", "age", "gender"))
ggplot() +
  geom_bar(data = merged_data, aes(x = factor(attend_demo)), width = 0.3) +
  geom_bar(data = merged_imputet_rounded, aes(x = factor(attend_demo)), fill = "red",
           position = position_nudge(x = 0.25), width = 0.3) +
  scale_x_discrete(breaks = unique(merged_data$attend_demo), 
                   labels = numeric_labels) +  # Apply labels
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate and adjust

```

comparison between the imputed and the original data for *join_strike* by bar chart. *imputed in red*.
```{r}
library(ggplot2)
library(scales)

# Define the string labels and their corresponding numeric values
numeric_labels <- c("1" = "Have done", "2" = "Might do",
                    "3" = "Would never do", "null" = "null ")

# Create the plot
data_columns <- setdiff(names(merged_data), c("country", "age", "gender"))
ggplot() +
  geom_bar(data = merged_data, aes(x = factor(join_strike)), width = 0.3) +
  geom_bar(data = merged_imputet_rounded, aes(x = factor(join_strike)), fill = "red",
           position = position_nudge(x = 0.25), width = 0.3) +
  scale_x_discrete(breaks = unique(merged_data$join_strike), 
                   labels = numeric_labels) +  # Apply labels
  theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate and adjust

```

comparison between the imputed and the original data for *employment* by bar chart. *imputed in red*.
```{r}
library(ggplot2)
library(scales)

# Define the string labels and their corresponding numeric values
numeric_labels <- c("1" = "Full time", "2" = "Part time", "3" = "Self employed",
                    "4" = "Retired", "5" = "Housewife not otherwise employed",
                    "6" = "Student", "7" = "Unemployed", "null" = "null")

# Create the plot
data_columns <- setdiff(names(merged_data), c("country", "age", "gender"))
ggplot() +
  geom_bar(data = merged_data, aes(x = factor(employment)), width = 0.3) +
  geom_bar(data = merged_imputet_rounded, aes(x = factor(employment)), fill = "red",
           position = position_nudge(x = 0.25), width = 0.3) +
  scale_x_discrete(breaks = unique(merged_data$employment), 
                   labels = numeric_labels) +  # Apply labels
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate and adjust

```

renaming the data in the data set.
```{r}
#=======employment==========================================================================
employment_mapping <- c(
  "1" = "Full time",
  "2" = "Part time",
  "3" = "Self employed",
  "4" = "Retired",
  "5" = "Housewife not otherwise employed",
  "6" = "Student",
  "7" = "Unemployed",
  "null" = "null"
)
#=======join_strike=========================================================================

join_strike_mapping <- c(
  "1" = "Have done",
  "2" = "Might do",
  "3" = "Would never do",
  "null" = "null"
)
#=======attend_demo=========================================================================

attend_demo_mapping <- c(
  "1" = "Have done",
  "2" = "Might do",
  "3" = "Would never do",
  "null" = "null"
)
#=======join_boycott========================================================================

join_boycott_mapping <- c(
  "1" = "Have done",
  "2" = "Might do",
  "3" = "Would never do",
  "null" = "null"
)
#=======sign_pet============================================================================

sign_pet_mapping <- c(
  "1" = "Have done",
  "2" = "Might do",
  "3" = "Would never do",
  "null" = "null"
)
#=======gen_trust===========================================================================

gen_trust_mapping <- c(
  "1" = "Most people can be trusted",
  "2" = "Need to be very careful",
  "null" = "null"
)
#=======financial_satis=====================================================================

financial_satis_mapping <- c(
  "1" = "Dissatisfied",
  "2" = "2",
  "3" = "3",
  "4" = "4",
  "5" = "5",
  "6" = "6",
  "7" = "7",
  "8" = "8",
  "9" = "9",
  "10" = "Satisfied",
  "null" = "null"
)
#=======life_satis==========================================================================

life_satis_mapping <- c(
  "1" = "compeltely dissatisfied",
  "2" = "2",
  "3" = "3",
  "4" = "4",
  "5" = "5",
  "6" = "6",
  "7" = "7",
  "8" = "8",
  "9" = "9",
  "10" = "compeltely Satisfied",
  "null" = "null"
)
#=======health============================================================================

health_mapping <- c(
  "1" = "Very good",
  "2" = "Good",
  "3" = "Fair",
  "4" = "Poor",
  "null" = "null"
)
#=======free_choice=========================================================================

free_choice_mapping <- c(
  "1" = "None at all",
  "2" = "2",
  "3" = "3",
  "4" = "4",
  "5" = "5",
  "6" = "6",
  "7" = "7",
  "8" = "8",
  "9" = "9",
  "10" = "A great deal",
  "null" = "null"
)
#=======happiness===========================================================================

happiness_mapping <- c(
  "1" = "Very happy",
  "2" = "Quite happy",
  "3" = "Not very happy",
  "4" = "Not at all happy",
  "null" = "null"
)
#=======gender===========================================================================

gender_mapping <- c(
  "1" = "Male",
  "2" = "Female",
  "null" = "null"
)

#=======religiosity=========================================================================

religiosity_mapping <- c(
  "1" = "Several times a day",
  "2"  = "Once a day",
  "3" = "Several times each week",
  "4" = "Only when attending religious services",
  "5" = "Only on special holy days",
  "6" = "Once a year",
  "7" = "Less often",
  "8" = "Never, practically never",
  "null" = "null"
)

#=======adding changes to new data frame====================================================

merged_renamed <- merged_imputet_rounded %>%
  mutate(
    employment = employment_mapping[as.character(employment)],
    join_strike = join_strike_mapping[as.character(join_strike)],
    attend_demo = attend_demo_mapping[as.character(attend_demo)],
    join_boycott = join_boycott_mapping[as.character(join_boycott)],
    sign_pet = sign_pet_mapping[as.character(sign_pet)],
    gen_trust = gen_trust_mapping[as.character(gen_trust)],
    financial_satis = financial_satis_mapping[as.character(financial_satis)],
    life_satis = life_satis_mapping[as.character(life_satis)],
    health = health_mapping[as.character(health)],
    free_choice = free_choice_mapping[as.character(free_choice)],
    happiness = happiness_mapping[as.character(happiness)],
    gender = gender_mapping[as.character(gender)],
    religiosity = religiosity_mapping[as.character(religiosity)]
  )
# Print the new dataframe
print(merged_renamed)
```


calculate the descriptive statistics.
```{r}
# Load required libraries
library(dplyr)
library(moments)
library(ggplot2)

# Assuming your dataset is named "your_dataset"
# Replace "your_dataset" with the actual name of your dataset

country_data <- merged_imputet_rounded %>%
  filter(country == "EGY")  # Filter data for EGY country

# List of variable names to calculate statistics for
variable_names <- c("happiness", "gen_trust", "health", "free_choice",
                    "life_satis", "financial_satis", "gen_trust",
                    "sign_pet", "join_boycott", "attend_demo",
                    "join_strike", "religiosity", 
                    "age", "gender", "employment")

# Initialize an empty list to store results
results_list <- list()

# Loop through each variable and calculate statistics
for (variable_name in variable_names) {
  variable_stats <- country_data %>%
    summarise(
      variable_name = variable_name,
      mean = mean(!!sym(variable_name), na.rm = TRUE),
      median = median(!!sym(variable_name), na.rm = TRUE),
      mode = as.numeric(names(sort(table(!!sym(variable_name)), decreasing = TRUE)[1])),
      variance = var(!!sym(variable_name), na.rm = TRUE),
      standard_deviation = sd(!!sym(variable_name), na.rm = TRUE),
      range = paste(range(!!sym(variable_name), na.rm = TRUE), collapse = " - "),
      iqr = IQR(!!sym(variable_name), na.rm = TRUE),
      skewness = skewness(!!sym(variable_name), na.rm = TRUE),
      kurtosis = kurtosis(!!sym(variable_name), na.rm = TRUE)
    )
  
  results_list[[variable_name]] <- variable_stats
}

# Combine results into a single data frame
results_df <- bind_rows(results_list)

# Print the results
print(results_df)


# List of variables to exclude
excluded_variables <- c("age", "gender")

# Filter out the excluded variables from the dataframe
filtered_results <- results_df %>% filter(!variable_name %in% excluded_variables)

# Create a bar chart for mean values
mean_bar_chart <- ggplot(filtered_results, aes(x = variable_name, y = mean)) +
  geom_bar(stat = "identity", fill = "blue") +
  labs(title = "Mean Values for Different Variables (Excluding Age and Gender) in EGY Country",
       x = "Variable", y = "Mean Value") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Print the bar chart
print(mean_bar_chart)

library(writexl)

# Define the file path for the Excel file
file_path <- "C:/Users/LENOVO/Desktop/DataMohammed/Data/statistics_results.xlsx"

# Write the data frame to the specified Excel file path
write_xlsx(filtered_results, path = file_path)

```

calculate the descriptive statistics. for each country seperately. 
```{r}
# Load required libraries
# Load required libraries
# Load required libraries
library(dplyr)
library(moments)
library(writexl)

# Assuming your dataset is named "merged_imputet_rounded"
# Replace "merged_imputet_rounded" with the actual name of your dataset

# List of country codes
country_codes <- c("EGY", "IRQ", "JOR", "LEB", "MOR", "TUN", "LIB")

# List of variable names to calculate statistics for
variable_names <- c("happiness", "gen_trust", "health", "free_choice",
                    "life_satis", "financial_satis", "gen_trust",
                    "sign_pet", "join_boycott", "attend_demo",
                    "join_strike", "religiosity", 
                    "age", "gender", "employment")

# Create a new Excel workbook
wb <- createWorkbook()

# Loop through each country
for (country_code in country_codes) {
  country_data <- merged_imputet_rounded %>%
    filter(country == country_code)  # Filter data for the current country

  # Initialize an empty list to store results for the current country
  country_results <- list()

  # Loop through each variable and calculate statistics for the current country
  for (variable_name in variable_names) {
    variable_stats <- country_data %>%
      summarise(
        variable_name = variable_name,
        mean = mean(!!sym(variable_name), na.rm = TRUE),  # Add na.rm = TRUE
        median = median(!!sym(variable_name), na.rm = TRUE),  # Add na.rm = TRUE
        mode = as.numeric(names(sort(table(!!sym(variable_name)), decreasing = TRUE)[1])),
        variance = var(!!sym(variable_name), na.rm = TRUE),  # Add na.rm = TRUE
        standard_deviation = sd(!!sym(variable_name), na.rm = TRUE),  # Add na.rm = TRUE
        range = paste(range(!!sym(variable_name), na.rm = TRUE), collapse = " - "),  # Add na.rm = TRUE
        iqr = IQR(!!sym(variable_name), na.rm = TRUE),  # Add na.rm = TRUE
        skewness = skewness(!!sym(variable_name), na.rm = TRUE),  # Add na.rm = TRUE
        kurtosis = kurtosis(!!sym(variable_name), na.rm = TRUE)  # Add na.rm = TRUE
      )
    
    # Append variable statistics to the country's results
    country_results[[variable_name]] <- variable_stats
  }

  # Combine results for the current country into a single data frame
  country_results_df <- bind_rows(country_results)

  # Add the country's statistics to a new sheet in the Excel workbook
  addWorksheet(wb, sheetName = country_code)
  writeData(wb, sheet = country_code, x = country_results_df, startCol = 1, startRow = 1)
}

# Save the Excel workbook with statistics for all countries
saveWorkbook(wb, "statistics_all_countries.xlsx")


```

multilevel analysis
```{r}
# Load necessary packages
library(lme4)
library(tidyverse)
model1 <- lmer(sign_pet ~ happiness + health + free_choice + life_satis + financial_satis + 
               gen_trust + age + gender + employment + religiosity + 
               (1|country) + var, data = final_dataset)
```


```{r}
model1_adv <- lmer(sign_pet ~ happiness * var + health + free_choice + life_satis + financial_satis + 
                   gen_trust + age * gender + employment + religiosity + 
                   (1 + happiness + age|country), 
                   data = final_dataset)
summary(model1_adv)
```


```{r}
# Load the required packages
library(lme4)
library(lmerTest)

# Load the dataset

# Fit the multivariate multilevel model
model <- lmer(cbind(sign_pet, join_boycott, attend_demo, join_strike) ~ 
              happiness + health + free_choice + life_satis + financial_satis +
              gen_trust + age + gender + employment + religiosity + 
              (1 + happiness + health + free_choice + life_satis + financial_satis | country) +
              (1 | var), 
              data = final_dataset)

# Show the model summary
summary(model)

# Produce various diagnostic plots
plot(model)
```


```{r}
fit1 <- lmer(sign_pet ~ happiness + health + free_choice + life_satis + financial_satis + (1 | country/var), data = final_dataset)
summary(fit1)

```


```{r}
# Load the required packages
library(lme4)
library(lmerTest)

# Load your dataset
# final_dataset <- read.csv("path/to/your/dataset.csv")

# Fit the multivariate multilevel models
fit1 <- lmer(sign_pet ~ happiness + health + free_choice + life_satis + financial_satis + (1 + happiness + health | country/var), data = final_dataset)
fit2 <- lmer(join_boycott ~ happiness + health + free_choice + life_satis + financial_satis + (1 + happiness + health | country/var), data = final_dataset)
fit3 <- lmer(attend_demo ~ happiness + health + free_choice + life_satis + financial_satis + (1 + happiness + health | country/var), data = final_dataset)
fit4 <- lmer(join_strike ~ happiness + health + free_choice + life_satis + financial_satis + (1 + happiness + health | country/var), data = final_dataset)

# Summarize the results
summary(fit1)
summary(fit2)
summary(fit3)
summary(fit4)

uniq(final_dataset$country)

```

```{r}
# Load the required packages
library(dplyr)
library(tidyr)
library(purrr)
library(openxlsx)

# Assuming your dataset is stored in a variable called 'final_dataset'
# Subset only the relevant variables for correlation
final_dataset_subset <- final_dataset %>%
  select(country, happiness, health, free_choice, life_satis, financial_satis, 
         gen_trust, age, gender, employment, sign_pet, 
         join_boycott, attend_demo, join_strike, religiosity)

# Define the list of countries
countries <- c("EGY", "IRQ", "JOR", "LEB", "MOR", "TUN", "LIB")

# Create an Excel workbook
wb <- createWorkbook()

# Generate and add a sheet for each country's correlation matrix
for (country_name in countries) {
  
  # Filter the data for each country
  country_data <- final_dataset_subset %>%
    filter(country == country_name) %>%
    select(-country)
  
  # Calculate the correlation matrix
  country_cor_matrix <- cor(country_data, use = "complete.obs", method = "pearson")
  
  # Create a sheet for the country's data in the Excel workbook
  addWorksheet(wb, sheetName = country_name)
  
  # Write the correlation matrix to the sheet
  writeData(wb, sheet = country_name, x = country_cor_matrix)
  
  # Add a column with variable names on the left side of the matrix
  variable_names <- colnames(country_cor_matrix)
  writeData(wb, sheet = country_name, x = variable_names, startCol = 1, startRow = 2)
}

# Save the Excel workbook to a file
saveWorkbook(wb, "correlation_matrices_with_variables.xlsx")
```


```{r}
# Load the required packages
library(dplyr)
library(tidyr)
library(purrr)
library(openxlsx)

# Assuming your dataset is stored in a variable called 'final_dataset'
# Subset only the relevant variables for correlation
final_dataset_subset <- final_dataset %>%
  select(country, happiness, health, free_choice, life_satis, financial_satis, 
         gen_trust, age, gender, employment, sign_pet, 
         join_boycott, attend_demo, join_strike, religiosity)

# Calculate the correlation matrix across all countries
cor_matrix <- cor(final_dataset_subset %>%
                    select(-country), use = "complete.obs", method = "pearson")

# Create an Excel workbook
wb <- createWorkbook()

# Create a sheet for the correlation matrix
addWorksheet(wb, sheetName = "Correlation Matrix")

# Write the correlation matrix to the sheet
writeData(wb, sheet = "Correlation Matrix", x = cor_matrix)

# Add a column with variable names on the left side of the matrix
variable_names <- colnames(cor_matrix)
writeData(wb, sheet = "Correlation Matrix", x = variable_names, startCol = 1, startRow = 2)

# Save the Excel workbook to a file
saveWorkbook(wb, "correlation_matrix_across_countries_with_variables.xlsx")


```

```{r}
# Load necessary packages
library(ppcor)

# Simulate your dataset or read it
# final_dataset <- read.csv("your_file.csv")

# List of countries
countries <- c("EGY", "IRQ", "JOR", "LEB", "MOR", "TUN", "LIB")

# Variables of interest
iv_vars <- c("happiness", "health", "free_choice", "life_satis", "financial_satis")
dv_vars <- c("join_boycott", "attend_demo", "join_strike", "religiosity")
control_vars <- c("gen_trust", "age", "gender", "employment", "sign_pet")

# Loop through each country
for (cty in countries) {
  subset_data <- subset(final_dataset, country == cty)
  
  # Remove rows with NA
  subset_data <- na.omit(subset_data)
  
  # Create a dataframe of IV and DV
  all_vars <- c(iv_vars, dv_vars, control_vars)
  df <- subset_data[, all_vars]
  
  # Compute partial correlations using GLM
  partial_correlations <- matrix(NA, length(iv_vars), length(dv_vars))
  colnames(partial_correlations) <- dv_vars
  rownames(partial_correlations) <- iv_vars

  for (iv in iv_vars) {
    for (dv in dv_vars) {
      fit <- lm(paste(dv, "~", iv, "+", paste(control_vars, collapse = " + ")), data = df)
      partial_correlations[iv, dv] <- summary(fit)$coefficients[2, "Estimate"]
    }
  }
  
  # Print the result
  cat("\nPartial Correlation Matrix for", cty, "\n")
  print(partial_correlations)
}


```




```{r}

library(ggcorrplot)
# Create the plot
  ggcorrplot(country_cor_matrix, 
             hc.order = TRUE, 
             type = "lower", 
             lab = TRUE, 
             lab_size = 3, 
             outline.col = "white", 
             ggtheme = ggplot2::theme_minimal()) +
    ggtitle(paste("Correlation Matrix for Country:", country_name)) +
    theme(plot.title = element_text(hjust = 0.5))

```

```{r}
library(brms)
# Define the Bayesian Multivariate Multilevel Model
formula <- bf(join_boycott ~ happiness + health + free_choice + life_satis + financial_satis + 
                            gen_trust + age + gender + employment + sign_pet + (1|country)) +
            bf(attend_demo ~ happiness + health + free_choice + life_satis + financial_satis + 
                            gen_trust + age + gender + employment + sign_pet + (1|country)) +
            bf(join_strike ~ happiness + health + free_choice + life_satis + financial_satis + 
                            gen_trust + age + gender + employment + sign_pet + (1|country)) +
            bf(religiosity ~ happiness + health + free_choice + life_satis + financial_satis + 
                            gen_trust + age + gender + employment + sign_pet + (1|country))

# Run the model
fit <- brm(formula, data = final_dataset, cores = 4, iter = 2000)

# Show summary
summary(fit)

```

```{r}
# Install and load the required packages
library(Hmisc)
library(openxlsx)

# Create an empty workbook
wb <- createWorkbook()

# List of unique countries
unique_countries <- unique(final_dataset$country)

# Loop through each country
for (ctry in unique_countries) {
  # Subset data for each country
  subset_data <- subset(final_dataset, country == ctry)
  
  # Variables of interest
  var_of_interest <- c("happiness", "health", "free_choice", "life_satis", "financial_satis",
                       "gen_trust", "age", "gender", "employment", "sign_pet",
                       "join_boycott", "attend_demo", "join_strike", "religiosity")
  
  # Generate correlation matrix and p-values
  corr_object <- rcorr(as.matrix(subset_data[, var_of_interest]))
  
  # Extract the correlation matrix and p-values
  corr_matrix <- corr_object$r
  p_values <- corr_object$P
  
  # Create a new sheet in the workbook for each country
  addWorksheet(wb, sheetName = ctry)
  
  # Write the correlation matrix with variable names on the left side
  writeData(wb, sheet = ctry, x = cbind(variables = rownames(corr_matrix), corr_matrix))
  
  # Calculate the number of rows in the correlation matrix
  num_rows <- nrow(corr_matrix)
  
  # Write p-values in a table below the correlation matrix
  writeData(wb, sheet = ctry, x = cbind(variables = rownames(p_values), p_values), startRow = num_rows + 3)
}

# Save workbook (you can choose your own file name and path)
saveWorkbook(wb, "Correlation_and_Pvalues_By_Country.xlsx", overwrite = TRUE)


```